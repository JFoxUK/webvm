FROM --platform=i386 i386/debian:buster

ARG DEBIAN_FRONTEND=noninteractive

# Install required packages
RUN apt-get update \
 && apt-get -y upgrade \
 && apt-get install -y apt-utils zip unzip vim less binutils curl \
 && rm -rf /var/lib/apt/lists/*

# Create user and home
RUN useradd -m user && echo "user:password" | chpasswd && echo "root:password" | chpasswd

# Create documents folder (WebVM expects this)
RUN mkdir -p /home/user/documents && chown -R user:user /home/user/documents

# Room 1 - Basic Commands
RUN mkdir -p /game/room1 \
 && echo "You awaken in a stone chamber. A note is here." > /game/room1/note.txt \
 && echo "Explore. Discover. Use the basics: ls, cd, cat." >> /game/room1/note.txt \
 && echo "The key is: bronze" > /game/room1/.key_room2

# Room 2 - Hidden and Nested
RUN mkdir -p /tmp/room2/deep/.hidden/path/to/secret \
 && echo "The scroll reads: 'Look deeper, young hacker.'" > /tmp/room2/clue1.txt \
 && echo "Try: find . -name 'key*' or grep -r 'key'" > /tmp/room2/clue2.txt \
 && echo "The key is: silver" > /tmp/room2/deep/.hidden/path/to/secret/key_room3.txt \
 && cd /tmp && zip -r -P bronze /game/room2.zip room2 \
 && rm -rf /tmp/room2

# Room 3 - VIM Editing Challenge
RUN mkdir -p /tmp/room3 \
 && echo "Edit me in vim and change OPEN=false to OPEN=true" > /tmp/room3/config.txt \
 && echo "OPEN=false" >> /tmp/room3/config.txt \
 && echo "Once saved, use grep to verify: grep OPEN config.txt" >> /tmp/room3/clue.txt \
 && echo "The key is: gold" > /tmp/room3/key.txt \
 && cd /tmp && zip -r -P silver /game/room3.zip room3 \
 && rm -rf /tmp/room3

# Room 4 - Obfuscated Clue
RUN mkdir -p /tmp/room4 \
 && echo 'Decode the cipher: VGhlIGtleSBpczogcGxhdGludW0=' > /tmp/room4/clue.txt \
 && echo "(Hint: it's base64)" >> /tmp/room4/clue.txt \
 && echo 'The key is: platinum' > /tmp/room4/decoded.txt \
 && cd /tmp && zip -r -P gold /game/room4.zip room4 \
 && rm -rf /tmp/room4

# Room 5 - Final Boss with binary
RUN mkdir -p /tmp/room5 \
 && echo "Use 'strings dragon' to reveal the key." > /tmp/room5/instructions.txt \
 && dd if=/dev/urandom bs=1 count=100 of=/tmp/room5/dragon 2>/dev/null \
 && echo 'diamond' >> /tmp/room5/dragon \
 && cd /tmp && zip -r -P platinum /game/room5.zip room5 \
 && rm -rf /tmp/room5

# Copy all zipped rooms to user's home
RUN cp -r /game/room1 /home/user/ && \
    cp /game/room2.zip /home/user/ && \
    cp /game/room3.zip /home/user/ && \
    cp /game/room4.zip /home/user/ && \
    cp /game/room5.zip /home/user/


# Set working directory and env
WORKDIR /home/user
ENV HOME="/home/user" TERM="xterm" USER="user" SHELL="/bin/bash" EDITOR="vim" LANG="en_US.UTF-8" LC_ALL="C"

# Start bash login shell
CMD ["/bin/bash", "-l"]